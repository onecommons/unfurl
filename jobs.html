<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Jobs and Workflows &mdash; Unfurl Documentation</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="_static/custom.css" type="text/css" />
    <link rel="shortcut icon" href="_static/favicon32.png"/>
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/custom.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Runtime Environment" href="runtime.html" />
    <link rel="prev" title="TOSCA" href="tosca.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html">
            
              <img src="_static/unfurl_logo.svg" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="README.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="README.html#installation">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="quickstart.html">Quick start</a></li>
<li class="toctree-l1"><a class="reference internal" href="get-started-step-by-step.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="ensembles.html">Ensembles</a></li>
<li class="toctree-l1"><a class="reference internal" href="projects.html">Unfurl Projects</a></li>
<li class="toctree-l1"><a class="reference internal" href="secrets.html">Managing Secrets</a></li>
<li class="toctree-l1"><a class="reference internal" href="tosca.html">TOSCA</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Jobs and Workflows</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#job-lifecycle">Job Lifecycle</a></li>
<li class="toctree-l2"><a class="reference internal" href="#operational-status-and-state">Operational status and state</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#node-state">Node state</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#changeids">ChangeIds</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="runtime.html">Runtime Environment</a></li>
<li class="toctree-l1"><a class="reference internal" href="configurators.html">Configurators</a></li>
<li class="toctree-l1"><a class="reference internal" href="configurators.html#installers">Installers</a></li>
<li class="toctree-l1"><a class="reference internal" href="processing.html">Template Processing</a></li>
<li class="toctree-l1"><a class="reference internal" href="expressions.html">Expression Functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="cli.html">Command Line</a></li>
<li class="toctree-l1"><a class="reference internal" href="jsonschema.html">Configuration Files</a></li>
<li class="toctree-l1"><a class="reference internal" href="toscaref.html">TOSCA Language Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="glossary.html">Glossary</a></li>
<li class="toctree-l1"><a class="reference internal" href="api.html">Python API</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Unfurl</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Jobs and Workflows</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/jobs.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="jobs-and-workflows">
<h1>Jobs and Workflows<a class="headerlink" href="#jobs-and-workflows" title="Permalink to this headline"></a></h1>
<p>The core behavior of Unfurl is to run a <a class="reference internal" href="glossary.html#job"><span class="std std-ref">Job</span></a> that executes a <a class="reference internal" href="glossary.html#workflow"><span class="std std-ref">Workflow</span></a> on a given topology instance.
There are two fundamental workflows (“normative workflows” in TOSCA terminology):
<a class="reference internal" href="cli.html#unfurl-deploy"><span class="std std-ref">deploy</span></a>, which installs the topology, and <a class="reference internal" href="cli.html#unfurl-undeploy"><span class="std std-ref">undeploy</span></a>, which uninstalls it.</p>
<p>There are also <a class="reference internal" href="cli.html#unfurl-check"><span class="std std-ref">check</span></a> and <a class="reference internal" href="cli.html#unfurl-discover"><span class="std std-ref">discover</span></a> workflows which update the status of
instances the based on their current live state.
Users can also define custom workflows but they do not affect the change history of the topology.</p>
<section id="job-lifecycle">
<h2>Job Lifecycle<a class="headerlink" href="#job-lifecycle" title="Permalink to this headline"></a></h2>
<p>When a command that invokes a workflow is executed (<a class="reference internal" href="cli.html#unfurl-deploy"><span class="std std-ref">deploy</span></a>, <a class="reference internal" href="cli.html#unfurl-undeploy"><span class="std std-ref">undeploy</span></a>, <a class="reference internal" href="cli.html#unfurl-check"><span class="std std-ref">check</span></a>, <a class="reference internal" href="cli.html#unfurl-discover"><span class="std std-ref">discover</span></a> and <a class="reference internal" href="cli.html#unfurl-run"><span class="std std-ref">run</span></a>)
a job is created and run. Running a job entails these steps:</p>
<ol class="arabic simple">
<li><p>YAML parsed and <a class="reference internal" href="processing.html#yaml-merge-directives"><span class="std std-ref">merge directives</span></a> are processed</p></li>
<li><p>Schema is validated and model instantiated. The command will exit if there are errors.</p></li>
<li><p>A plan is constructed based on the selected workflow and job options (use <a class="reference external" href="cli.html#unfurl-plan">unfurl plan</a> command to preview) and the job begins.</p></li>
<li><p>For each operation a task is generated and the operation’s <a class="reference internal" href="toscaref/spec-inputs.html#inputs"><span class="std std-ref">Inputs</span></a> are lazily evaluated
if referenced, including Unfurl expressions, TOSCA functions, and template strings.</p></li>
<li><p>After the job completes, <a class="reference internal" href="jsonschema.html#id2"><span class="std std-ref">ensemble.yaml</span></a> is updated with any changes to its instances status.
<code class="docutils literal notranslate"><span class="pre">jobs.tsv</span></code> will also be updated with line for each task run and a new <a class="reference internal" href="jsonschema.html#id3"><span class="std std-ref">job.yaml</span></a> file is created in the <code class="docutils literal notranslate"><span class="pre">jobs</span></code> folder.</p></li>
<li><p>Depending on the commit options of the job, the ensemble’s git repository will see a new commit,
along with any other repository that had changes to it (e.g. files in the <code class="docutils literal notranslate"><span class="pre">spec</span></code> directory).</p></li>
</ol>
</section>
<section id="operational-status-and-state">
<h2>Operational status and state<a class="headerlink" href="#operational-status-and-state" title="Permalink to this headline"></a></h2>
<p>When a workflow job is run, it updates the status of its affected instances.
Each <a class="reference internal" href="jsonschema.html#instance"><span class="std std-ref">Instance</span></a> represented in a manifest has a status that indicates
its relationship to its specification:</p>
<blockquote>
<div><dl class="field-list simple">
<dt class="field-odd">Unknown</dt>
<dd class="field-odd"><p>The operational state of the instance is unknown.</p>
</dd>
<dt class="field-even">Pending</dt>
<dd class="field-even"><p>Instance is being brought up or hasn’t been created yet.</p>
</dd>
<dt class="field-odd">OK</dt>
<dd class="field-odd"><p>Instance is operational</p>
</dd>
<dt class="field-even">Degraded</dt>
<dd class="field-even"><p>Instance is operational but in a degraded state.</p>
</dd>
<dt class="field-odd">Error</dt>
<dd class="field-odd"><p>Instance is not operational.</p>
</dd>
<dt class="field-even">Absent</dt>
<dd class="field-even"><p>Instance confirmed to not exist.</p>
</dd>
</dl>
</div></blockquote>
<p>When a workflow is applied to an instance it will be skipped if it already has
the desired status (either “OK” or “Absent”). If its status is <code class="docutils literal notranslate"><span class="pre">Unknown</span></code>,
<a class="reference internal" href="cli.html#unfurl-check"><span class="std std-ref">check</span></a> will be run first. Otherwise the workflow will be applied by executing one or more <a class="reference internal" href="glossary.html#operation"><span class="std std-ref">operations</span></a> on a target instance.</p>
<p>If it succeeds, the target instance status will be set to either <code class="docutils literal notranslate"><span class="pre">OK</span></code> or <code class="docutils literal notranslate"><span class="pre">Absent</span></code>
for <a class="reference internal" href="cli.html#unfurl-deploy"><span class="std std-ref">deploy</span></a> and <a class="reference internal" href="cli.html#unfurl-undeploy"><span class="std std-ref">undeploy</span></a>, respectively.
If it fails, the status will depend on whether the instance was modified by the operation.
If it has been, the status is set to <code class="docutils literal notranslate"><span class="pre">Error</span></code> (or to <code class="docutils literal notranslate"><span class="pre">Degraded</span></code> the task was optional);
if the operation didn’t report whether or not it was modified, it is set to <code class="docutils literal notranslate"><span class="pre">Unknown</span></code>.
Otherwise, the status won’t be changed.</p>
<section id="node-state">
<h3>Node state<a class="headerlink" href="#node-state" title="Permalink to this headline"></a></h3>
<p>In addition, each instance has a <code class="docutils literal notranslate"><span class="pre">node</span> <span class="pre">state</span></code> which indicates where the instance is in
it deployment lifecycle. Node states are defined by TOSCA and include:
<code class="docutils literal notranslate"><span class="pre">initial</span></code>, <code class="docutils literal notranslate"><span class="pre">creating</span></code>, <code class="docutils literal notranslate"><span class="pre">created</span></code>, <code class="docutils literal notranslate"><span class="pre">configuring</span></code>, <code class="docutils literal notranslate"><span class="pre">configured</span></code>,
<code class="docutils literal notranslate"><span class="pre">starting</span></code>, <code class="docutils literal notranslate"><span class="pre">started</span></code>, <code class="docutils literal notranslate"><span class="pre">stopping</span></code>, <code class="docutils literal notranslate"><span class="pre">deleting</span></code>, <code class="docutils literal notranslate"><span class="pre">deleted</span></code>, and <code class="docutils literal notranslate"><span class="pre">error</span></code>.</p>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference external" href="_static/TOSCA-Simple-Profile-YAML-v1.3-os-toc.html#_Toc454457724">TOSCA 1.3, §3.4.1</a> for a complete definitions</p>
</div>
<p>As <a class="reference internal" href="glossary.html#operation"><span class="std std-ref">operations</span></a> are executed during a job, the target instance’s <a class="reference internal" href="#node-state"><span class="std std-ref">Node state</span></a> is updated.</p>
</section>
</section>
<section id="changeids">
<h2>ChangeIds<a class="headerlink" href="#changeids" title="Permalink to this headline"></a></h2>
<p>Each <a class="reference internal" href="glossary.html#tasks"><span class="std std-ref">task</span></a> in a <a class="reference internal" href="glossary.html#job"><span class="std std-ref">Job</span></a> corresponds to an operation that was executed and is assigned a
<a class="reference internal" href="jsonschema.html#changeid"><span class="std std-ref">changeId</span></a>. Each task is recorded in the job’s <a class="reference internal" href="jsonschema.html#id3"><span class="std std-ref">changelog</span></a> as a <a class="reference internal" href="api.html#unfurl.job.ConfigChange" title="unfurl.job.ConfigChange"><code class="xref any py py-class docutils literal notranslate"><span class="pre">ConfigChange</span></code></a>,
which designed so that it can replayed to reproduce the instance.</p>
<p>ChangeIds are unique within the lifespan of an ensemble and sortable using an encoded timestamp.
All copies of an ensemble maintain a consistent view of time to ensure proper serialization and easy of merging of changes
(using locking if necessary).</p>
<p>Instances keep track of the last operation that was applied to it and also of the last
task that observed changes to the internal state of the instance (which may or may not be
reflected in attributes exposed in the topology model). Tracking internal state
is useful because dependent instances may need to know when it has changed and to know
if it is safe to delete an instance.</p>
<p>When status of an instance is saved in the manifest, the attributes described above
can be found in its <a class="reference internal" href="jsonschema.html#readystate"><span class="std std-ref">readyState</span></a> section, for example:</p>
<div class="highlight-YAML notranslate"><div class="highlight"><pre><span></span><span class="nt">readyState</span><span class="p">:</span>
<span class="w">  </span><span class="nt">local</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ok</span><span class="w"> </span><span class="c1"># the explicit status of this instance</span>
<span class="w">  </span><span class="nt">effective</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ok</span><span class="w"> </span><span class="c1"># its status with its dependencies&#39; statuses considered</span>
<span class="w">  </span><span class="nt">state</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">started</span><span class="w"> </span><span class="c1"># node state</span>
<span class="nt">lastConfigChange</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">A0AP4P9C0001</span><span class="w"> </span><span class="c1"># change id of the last ConfigChange that was applied</span>
<span class="nt">lastStateChange</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">A0DEVF0003</span><span class="w"> </span><span class="c1"># change id of the last detected change to the instance</span>
</pre></div>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="tosca.html" class="btn btn-neutral float-left" title="TOSCA" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="runtime.html" class="btn btn-neutral float-right" title="Runtime Environment" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, OneCommons Co..</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>