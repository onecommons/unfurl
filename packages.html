<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Repositories and Packages &mdash; Unfurl Documentation</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="_static/design-style.1e8bd061cd6da7fc9cf755528e8ffc24.min.css" type="text/css" />
      <link rel="stylesheet" href="_static/custom.css" type="text/css" />
    <link rel="shortcut icon" href="_static/favicon32.png"/>
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/design-tabs.js"></script>
        <script src="_static/custom.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Managing Secrets" href="secrets.html" />
    <link rel="prev" title="Type Definitions" href="toscadef.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html">
            
              <img src="_static/unfurl_logo.svg" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="README.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="README.html#installation">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="quickstart.html">Quick start</a></li>
<li class="toctree-l1"><a class="reference internal" href="solution-overview.html">Solution Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="projects.html">Unfurl Projects</a></li>
<li class="toctree-l1"><a class="reference internal" href="ensembles.html">Ensembles</a></li>
<li class="toctree-l1"><a class="reference internal" href="jobs.html">Jobs and Workflows</a></li>
<li class="toctree-l1"><a class="reference internal" href="tosca.html">TOSCA</a></li>
<li class="toctree-l1"><a class="reference internal" href="dsl.html">TOSCA as Python</a></li>
<li class="toctree-l1"><a class="reference internal" href="toscaref.html">TOSCA Language Reference</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Repositories and Packages</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#repositories">Repositories</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#predefined-repositories">Predefined Repositories</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#packages">Packages</a></li>
<li class="toctree-l2"><a class="reference internal" href="#package-resolution">Package Resolution</a></li>
<li class="toctree-l2"><a class="reference internal" href="#package-identifiers">Package identifiers</a></li>
<li class="toctree-l2"><a class="reference internal" href="#version-requirements">Version Requirements</a></li>
<li class="toctree-l2"><a class="reference internal" href="#locked-ensembles">Locked ensembles</a></li>
<li class="toctree-l2"><a class="reference internal" href="#package-rules">Package Rules</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="secrets.html">Managing Secrets</a></li>
<li class="toctree-l1"><a class="reference internal" href="runtime.html">Runtime Environment</a></li>
<li class="toctree-l1"><a class="reference internal" href="configurators.html">Configurators</a></li>
<li class="toctree-l1"><a class="reference internal" href="configurators.html#installers">Installers</a></li>
<li class="toctree-l1"><a class="reference internal" href="configurators.html#configurators-artifacts">Artifacts</a></li>
<li class="toctree-l1"><a class="reference internal" href="processing.html">Template Processing</a></li>
<li class="toctree-l1"><a class="reference internal" href="expressions.html">Expression Functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="cloudmap.html">Cloud Maps</a></li>
<li class="toctree-l1"><a class="reference internal" href="cli.html">Command Line</a></li>
<li class="toctree-l1"><a class="reference internal" href="jsonschema.html">Configuration Files</a></li>
<li class="toctree-l1"><a class="reference internal" href="glossary.html">Glossary</a></li>
<li class="toctree-l1"><a class="reference internal" href="api.html">Python API</a></li>
<li class="toctree-l1"><a class="reference internal" href="CHANGELOG.html">Changelog for Unfurl</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Unfurl</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Repositories and Packages</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/packages.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="repositories-and-packages">
<h1>Repositories and Packages<a class="headerlink" href="#repositories-and-packages" title="Permalink to this headline"></a></h1>
<p>Unfurl can track the upstream repositories that contain the TOSCA templates, artifacts, and code used during deployment. It will download local copies, detect upstream changes, and apply semantic versioning to detecting conflicts and potentially breaking changes.</p>
<p>In Unfurl, a <code class="docutils literal notranslate"><span class="pre">repository</span></code> is a TOSCA abstraction that can represent any collection of artifacts. For example, a repository can be git repository, an OCI (Docker) container registry, or a local file directory. You can also define virtual repositories with an explicit list of artifacts.</p>
<p>A <code class="docutils literal notranslate"><span class="pre">package</span></code> is a similar abstraction in that a package is a collection of artifacts but unlike a repository it isn’t tied to a particular location – instead it has a <a class="reference internal" href="#package-identifiers"><span class="std std-ref">package identifier</span></a> that uniquely identifies the package. In addition, a package also can have a revision identifier associated with it that (optionally) conforms to the semantic versioning specification.</p>
<p>In a manner similar to common package managers like node.js’ npm or go modules, Unfurl will apply package resolution to make sure all references to a package use the same revision – for example, when multiple repository definitions refer to the same package.</p>
<section id="repositories">
<h2>Repositories<a class="headerlink" href="#repositories" title="Permalink to this headline"></a></h2>
<p>You declare repositories using TOSCA’s <a class="reference internal" href="toscaref/spec-repositories.html#tosca-repositories"><span class="std std-ref">repository</span></a> syntax at the top-level of a TOSCA service template or in the <a class="reference internal" href="jsonschema.html#environment"><span class="std std-ref">environment</span></a> section of your project’s <a class="reference internal" href="jsonschema.html#id4"><span class="std std-ref">unfurl.yaml</span></a>.</p>
<p>You can also create “virtual” repositories by declaring node templates of type <code class="docutils literal notranslate"><span class="pre">unfurl.nodes.Repository</span></code> or <code class="docutils literal notranslate"><span class="pre">unfurl.nodes.LocalRepository</span></code>. This will instantiate a repository with same name as the template and it will contain the artifacts listed in the <code class="docutils literal notranslate"><span class="pre">artifacts</span></code> section of the node template – here’s <a class="reference external" href="https://github.com/onecommons/unfurl/blob/f5da8de13ae2dcce293508c4ccac9b373e66dd49/unfurl/tosca_plugins/artifacts.yaml#L140">an example</a>.</p>
<p>The contents of a <a class="reference internal" href="toscaref/spec-repositories.html#tosca-repositories"><span class="std std-ref">repository</span></a> can be referenced in the following ways:</p>
<ul class="simple">
<li><p>In TOSCA <a class="reference internal" href="toscaref/spec-imports.html#imports"><span class="std std-ref">Imports</span></a> statements.</p></li>
<li><p>In TOSCA <a class="reference external" href="_static/TOSCA-Simple-Profile-YAML-v1.3-os-toc.html#_Toc50125252">artifacts</a> definitions.</p></li>
<li><p>In the <a class="reference internal" href="processing.html#yaml-merge-directives"><span class="std std-ref">+include YAML merge directive</span></a>.</p></li>
<li><p>In runtime expressions such as <a class="reference internal" href="expressions.html#abspath"><span class="std std-ref">abspath</span></a> and <a class="reference internal" href="expressions.html#get-dir"><span class="std std-ref">get_dir</span></a>.</p></li>
</ul>
<p>File paths in configuration files (e.g. include directives, imports, and external file references) are relative to the project and Unfurl will raise error if a file path would escapes outside the project.
To access file outside a project, declare a <a class="reference internal" href="toscaref/spec-repositories.html#repositories"><span class="std std-ref">repository</span></a> with an absolute file URL and use it in the file reference.</p>
<section id="predefined-repositories">
<h3>Predefined Repositories<a class="headerlink" href="#predefined-repositories" title="Permalink to this headline"></a></h3>
<p>There are three predefined repositories:</p>
<p>“self”, which represents the location the ensemble lives in – it will be a “git-local:” URL if no git remote has been set, or a “file:” URL if the ensemble is not part of a git repository at all.</p>
<p>“spec” which, unless explicitly declared, defaults to the project root or the ensemble itself if it is not part of a project.</p>
<p>“unfurl” which points to the Python package of the unfurl process – this can be used to load configurators and templates
that ship with Unfurl. This allow service templates to declare the unfurl version they are compatible with by declaring a repository for the unfurl package like so:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">repositories</span><span class="p">:</span>
<span class="w">  </span><span class="nt">unfurl</span><span class="p">:</span>
<span class="w">    </span><span class="nt">url</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">https://github.com/onecommons/unfurl</span>
<span class="w">    </span><span class="nt">revision</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v0.9.1</span>
</pre></div>
</div>
<p>Unfurl will still resolve imports in the unfurl package using the local installed version of unfurl but it will raise an error if it isn’t compatible with the version declared here.</p>
</section>
</section>
<section id="packages">
<h2>Packages<a class="headerlink" href="#packages" title="Permalink to this headline"></a></h2>
<p>A repository will also be treated as a <code class="docutils literal notranslate"><span class="pre">package</span></code> if the repository URL points to a git repository and can be transformed to match the package identifier syntax described below.</p>
<p>A repository that is a package can also have a revision associated with it, either embedded in the URL (git URLs have can have refs in the URL fragment) or by adding a <code class="docutils literal notranslate"><span class="pre">revision</span></code> key to the <a class="reference internal" href="toscaref/spec-repositories.html#tosca-repositories"><span class="std std-ref">repository definition</span></a>.</p>
<p>If a revision matches the <a class="reference external" href="https://semver.org/">semantic versioning syntax</a> it will be treated as a semantic version, otherwise it is treated as a opaque identifier with no implied semantics. For example, a revision can be  a git branch whose contents changes over time.</p>
<p>If no revision is specified when cloning a repository for the first time,  Unfurl will attempt to detect the latest version of the package by retrieving the upstream remote repository’s git tags and setting the revision to tag that looks like the most recent semantic version (see <a class="reference external" href="https://go.dev/ref/mod#vcs-version">https://go.dev/ref/mod#vcs-version</a> for the algorithm). If none is found, the latest commit from repository’s default branch will be used. To override version detection, set the <code class="docutils literal notranslate"><span class="pre">revision</span></code> to a branch like “main”. If the <a class="reference external" href="cli.html#unfurl">–check-upstream</a> global option was set, Unfurl it will also apply this same logic to existing repositories unless they are <a class="reference internal" href="#locked-ensembles"><span class="std std-ref">locked</span></a>.</p>
</section>
<section id="package-resolution">
<h2>Package Resolution<a class="headerlink" href="#package-resolution" title="Permalink to this headline"></a></h2>
<p>If a repository is treated as a package, multiple repositories that resolve to the same package will use the same local content, even the repository definitions use different URLs (this can happen with <a class="reference internal" href="#package-rules"><span class="std std-ref">Package Rules</span></a>). So if repository specify different revisions those revision need to be compatible.</p>
<p>If the revision looks like a semantic version the <a class="reference external" href="https://semver.org/">semantic versioning rules</a> for version compatibility will be used otherwise the version specifiers need to be identical. If the revisions are not compatible, Unfurl will abort with an error. Otherwise, like Go, it will choose the minimum required version for the repositories.</p>
</section>
<section id="package-identifiers">
<h2>Package identifiers<a class="headerlink" href="#package-identifiers" title="Permalink to this headline"></a></h2>
<p>Here are some examples of package ids:</p>
<blockquote>
<div><p><code class="docutils literal notranslate"><span class="pre">unfurl.cloud/onecommons/unfurl-types</span></code></p>
<p><code class="docutils literal notranslate"><span class="pre">example.org</span></code></p>
<p><code class="docutils literal notranslate"><span class="pre">example.org/mypackage/v2</span></code></p>
</div></blockquote>
<p>If the package references to a path in a git repository we follow Go’s convention for including the path after “.git/” in the name. For example:</p>
<blockquote>
<div><p><code class="docutils literal notranslate"><span class="pre">onecommons.org/unfurl-type.git/anotherpackage/v2</span></code></p>
<p><code class="docutils literal notranslate"><span class="pre">gitlab.com/onecommons/unfurl-types.git/v2</span></code></p>
</div></blockquote>
<p>Package identifiers resolve to a git repository following the algorthims for <a class="reference external" href="https://go.dev/ref/mod">Go modules</a> Repository declarations can include required version either by including a <code class="docutils literal notranslate"><span class="pre">revision</span></code> field or by including it as a URL fragment in the package identifier (e.g <code class="docutils literal notranslate"><span class="pre">#v1.1.0</span></code>).</p>
</section>
<section id="version-requirements">
<h2>Version Requirements<a class="headerlink" href="#version-requirements" title="Permalink to this headline"></a></h2>
<p>In addition to repositories and packages, you can assign versions to the following items:</p>
<ul class="simple">
<li><p>On service templates, using the <a class="reference external" href="_static/TOSCA-Simple-Profile-YAML-v1.3-os-toc.html#_Toc50125480">template_version</a> metadata field</p></li>
<li><p>On TOSCA type definitions, using the <a class="reference external" href="_static/TOSCA-Simple-Profile-YAML-v1.3-os-toc.html#_Toc50125343">version</a> field</p></li>
<li><p>On artifacts, using the built-in <code class="docutils literal notranslate"><span class="pre">version</span></code>  field on artifact templates.</p></li>
<li><p>You can also use the <a class="reference external" href="_static/TOSCA-Simple-Profile-YAML-v1.3-os-toc.html#_Toc50125187">version</a> TOSCA simple data type when declaring properties, inputs, etc.</p></li>
</ul>
<p>You can use version requirements to check the version compatibility of these items in the following ways:</p>
<ul class="simple">
<li><p>When importing <a class="reference internal" href="projects.html#external-ensembles"><span class="std std-ref">External ensembles</span></a>, you can validate the service template’s version.</p></li>
<li><p>When selecting and matching node templates, version requirements can be checked using a <code class="docutils literal notranslate"><span class="pre">node_filter</span></code> with a <code class="docutils literal notranslate"><span class="pre">version</span></code> constraint.</p></li>
</ul>
<p>Version requirements can have the following syntax:</p>
<blockquote>
<div><ul class="simple">
<li><p>Semver (caret) requirements: ^1.2.0 matches 1.2.5, 1.9.1 but not 2.0.0 (the default if no operator is specified)</p></li>
<li><p>Minimum (tilde) requirements: ~1.2.3 matches 1.2.5 but not 1.3.0 or 1.1.9</p></li>
<li><p>Comparison requirements (&gt;=, &gt;, &lt;, &lt;=, =)</p></li>
<li><p>Multiple requirements (“&gt;= 1.2.0, &lt; 1.5.0”)</p></li>
<li><p>Exact matches: If the value doesn’t match version requirement syntax, versions must match exactly.</p></li>
</ul>
</div></blockquote>
<p>See <a class="reference external" href="https://doc.rust-lang.org/cargo/reference/specifying-dependencies.html#version-requirement-syntax">Rust’s cargo’s documentation</a> for full discussion of their syntax and semantics.</p>
</section>
<section id="locked-ensembles">
<h2>Locked ensembles<a class="headerlink" href="#locked-ensembles" title="Permalink to this headline"></a></h2>
<p>An ensemble’s manifest may contain a <a class="reference internal" href="jsonschema.html#lock"><span class="std std-ref">lock section</span></a> that records the exact version and state of the repositories, packages, and deployment tools used when the ensemble was last deployed. It is conceptually similar to the lock files used in development environments for building and packaging applications (such as node.js’ yarn.lock and package-lock.json or Rust’s cargo.lock) .</p>
<p>Once an ensemble is deployed and is live, if a repository appears in the <a class="reference internal" href="jsonschema.html#lock"><span class="std std-ref">lock section</span></a> of the ensemble, the revision recorded in the <a class="reference internal" href="jsonschema.html#lock"><span class="std std-ref">lock section</span></a> for the repository will be used in subsequent jobs for that ensemble, overriding other package resolution logic.</p>
<p>If Unfurl was unable to find any semantic version tags for a repository, the <a class="reference internal" href="jsonschema.html#lock"><span class="std std-ref">lock section</span></a> will record this. In that case, subsequent deployments will attempt to fetch the earliest semantic version tag if found and no other revision was specified (as opposed to the default behavior of fetching the latest version tag). This is to handle the case when a package transitions from being unreleased to released.</p>
</section>
<section id="package-rules">
<h2>Package Rules<a class="headerlink" href="#package-rules" title="Permalink to this headline"></a></h2>
<p>You can define package rules that are applied to package definitions, overriding the location or version of a package or replacing the package identifier.</p>
<p>If a key in a <a class="reference internal" href="toscaref/spec-repositories.html#repositories"><span class="std std-ref">Repositories</span></a> section look like package identifier that it will be treated as a package rule instead of a repository definition. Some examples:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">environments</span><span class="p">:</span>
<span class="w">  </span><span class="nt">defaults</span><span class="p">:</span>
<span class="w">    </span><span class="nt">repositories</span><span class="p">:</span>
<span class="w">      </span><span class="c1"># set the repository URL and optionally the version for the given package</span>
<span class="w">      </span><span class="nt">unfurl.cloud/onecommons/blueprints/wordpress</span><span class="p">:</span>
<span class="w">        </span><span class="nt">url</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">https://unfurl.cloud/user/repo.git#main</span><span class="w"> </span><span class="c1"># set the package to a specific repository url that also sets the branch</span>

<span class="w">      </span><span class="c1"># if url is set to a package identifier, replace a package with another</span>
<span class="w">      </span><span class="nt">unfurl.cloud/onecommons/unfurl-types</span><span class="p">:</span>
<span class="w">        </span><span class="nt">url</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">github.com/user1/myfork</span>

<span class="w">      </span><span class="c1"># A trailing * applies the rule to all packages that match</span>
<span class="w">      </span><span class="nt">unfurl.cloud/onecommons/*</span><span class="p">:</span>
<span class="w">        </span><span class="nt">url</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">https://staging.unfurl.cloud/onecommons/*</span>

<span class="w">      </span><span class="c1"># replace for a particular package, version combination</span>
<span class="w">      </span><span class="l l-Scalar l-Scalar-Plain">unfurl.cloud/onecommons/blueprints/ghost#v1.6.0</span><span class="p p-Indicator">:</span>
<span class="w">        </span><span class="nt">url</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">github.com/user1/myforks.git/ghost</span>
<span class="w">        </span><span class="nt">revision</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1.6.1</span><span class="w"> </span><span class="c1"># e.g. a security patch</span>
</pre></div>
</div>
<p>You can also set these rules with the <code class="docutils literal notranslate"><span class="pre">UNFURL_PACKAGE_RULES</span></code> environment variable where the repository key and the <code class="docutils literal notranslate"><span class="pre">url</span></code> value are paired together and separated by spaces. If you want to specify the <code class="docutils literal notranslate"><span class="pre">revision</span></code>, spell it as an URL fragment (“#revision”) and append that to the URL if you need to specify both. This example defines two rules:</p>
<p><code class="docutils literal notranslate"><span class="pre">`UNFURL_PACKAGE_RULES=&quot;unfurl.cloud/onecommons/*</span> <span class="pre">#main</span> <span class="pre">unfurl.cloud/onecommons/unfurl-types</span> <span class="pre">github.com/user1/myfork&quot;`</span></code></p>
<p>The first rule sets the revision of matching packages to the branch “main”, and the second replaces one package with another package.</p>
<p>If a <code class="docutils literal notranslate"><span class="pre">UNFURL_PACKAGE_RULES</span></code> environment variable is defined, its package rules are appended to the list of package rules in the enviroment’s <a class="reference internal" href="toscaref/spec-repositories.html#repositories"><span class="std std-ref">Repositories</span></a> section.</p>
<p>The active packages rules of an ensemble are saved in its <a class="reference internal" href="jsonschema.html#lock"><span class="std std-ref">lock section</span></a> and are used in subsequent deployments if the ensemble’s environment did not define any package rules.</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="toscadef.html" class="btn btn-neutral float-left" title="Type Definitions" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="secrets.html" class="btn btn-neutral float-right" title="Managing Secrets" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, OneCommons Co..</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>